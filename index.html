<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Timetable Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #f50057;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --light-bg: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --public-holiday: #ffcdd2;
            --school-holiday: #c8e6c9;
            --optional-holiday: #fff9c4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-left h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .header-right button {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .header-right button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            background-color: #f9f9f9;
        }
        
        .tab.active {
            background-color: #f0f4ff;
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .tab i {
            margin-right: 8px;
        }
        
        .content-section {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: none;
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #303f9f;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #c51162;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #388e3c;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background-color: #fafafa;
            border-radius: 10px;
            border: 2px dashed var(--border-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #bdbdbd;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #757575;
        }
        
        .empty-state p {
            color: #9e9e9e;
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background-color: #f8fbff;
            margin-bottom: 20px;
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .upload-area input {
            display: none;
        }
        
        .upload-area label {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
        }
        
        .file-type-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-type-btn {
            padding: 10px 30px;
            background-color: #e8eaf6;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .file-type-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary-color);
        }
        
        .summary-card h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .holiday-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .holiday-card {
            padding: 20px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .public-holiday {
            background-color: var(--public-holiday);
            border-left: 5px solid var(--danger-color);
        }
        
        .school-holiday {
            background-color: var(--school-holiday);
            border-left: 5px solid var(--success-color);
        }
        
        .optional-holiday {
            background-color: var(--optional-holiday);
            border-left: 5px solid var(--warning-color);
        }
        
        .holiday-card h3 {
            margin-bottom: 10px;
        }
        
        .holiday-date {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .view-selector {
            display: flex;
            background-color: white;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .view-option {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .view-option:hover {
            background-color: #f9f9f9;
        }
        
        .view-option.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .timetable-container {
            overflow-x: auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .timetable {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .timetable th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .timetable td {
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            vertical-align: middle;
        }
        
        .period-cell {
            min-height: 70px;
            position: relative;
        }
        
        .period-subject {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .period-teacher {
            font-size: 0.85rem;
            color: #666;
        }
        
        .period-time {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.75rem;
            color: #999;
        }
        
        .holiday-cell {
            background-color: #ffebee;
            font-weight: 600;
            color: #d32f2f;
        }
        
        .break-cell {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .overlap {
            background-color: #ffebee !important;
            border: 2px solid #f44336 !important;
        }
        
        .overlap-warning {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #f44336;
            font-size: 0.8rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-controls select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: white;
            min-width: 200px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .time-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .time-input-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
        }
        
        .time-input-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .time-input-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        
        .reschedule-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .swap-highlight {
            background-color: #fff9c4 !important;
            border: 2px dashed #ff9800 !important;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 768px) {
            .header-right {
                display: none;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 0 50%;
                padding: 12px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-controls select {
                width: 100%;
            }
            
            .time-input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1><i class="fas fa-calendar-alt"></i> School Timetable Manager</h1>
                <p>Manage timetables, holidays, and teacher schedules efficiently</p>
            </div>
            <div class="header-right">
                <button id="dashboardBtn">
                    <i class="fas fa-tachometer-alt"></i> Back to Dashboard
                </button>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-target="holidays-section">
                <i class="fas fa-umbrella-beach"></i> Holidays
            </div>
            <div class="tab" data-target="view-timetable-section">
                <i class="fas fa-calendar-day"></i> View Timetable
            </div>
            <div class="tab" data-target="upload-timetable-section">
                <i class="fas fa-file-upload"></i> Upload Timetable
            </div>
            <div class="tab" data-target="modify-timetable-section">
                <i class="fas fa-edit"></i> Modify Timetable
            </div>
            <div class="tab" data-target="teacher-schedule-section">
                <i class="fas fa-chalkboard-teacher"></i> Teacher Schedule
            </div>
        </div>
        
        <!-- Holidays Section -->
        <div class="content-section active" id="holidays-section">
            <div class="section-header">
                <h2><i class="fas fa-umbrella-beach"></i> Holiday Management</h2>
                <div class="section-actions">
                    <select id="yearSelect" class="form-control" style="width: auto;">
                        <option value="2026">Academic Year 2026</option>
                        <option value="2025">Academic Year 2025</option>
                        <option value="2024">Academic Year 2024</option>
                    </select>
                    <button class="btn btn-primary" id="addHolidayBtn">
                        <i class="fas fa-plus"></i> Add Holiday
                    </button>
                    <button class="btn btn-success" id="exportHolidaysBtn">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="data-summary">
                <div class="summary-card">
                    <h3>Total Holidays</h3>
                    <div class="value" id="totalHolidays">0</div>
                </div>
                <div class="summary-card">
                    <h3>Public Holidays</h3>
                    <div class="value" id="publicHolidays">0</div>
                </div>
                <div class="summary-card">
                    <h3>School Holidays</h3>
                    <div class="value" id="schoolHolidays">0</div>
                </div>
                <div class="summary-card">
                    <h3>Optional Holidays</h3>
                    <div class="value" id="optionalHolidays">0</div>
                </div>
            </div>
            
            <div id="holidaysList">
                <div class="empty-state">
                    <i class="fas fa-umbrella-beach"></i>
                    <h3>No Holidays Added Yet</h3>
                    <p>Start by adding your first holiday. You can add public holidays, school holidays, or optional holidays.</p>
                    <button class="btn btn-primary" id="addFirstHolidayBtn">
                        <i class="fas fa-plus"></i> Add First Holiday
                    </button>
                </div>
            </div>
        </div>
        
        <!-- View Timetable Section -->
        <div class="content-section" id="view-timetable-section">
            <div class="section-header">
                <h2><i class="fas fa-calendar-day"></i> View Timetable</h2>
                <div class="section-actions">
                    <button class="btn btn-success" id="exportTimetableBtn">
                        <i class="fas fa-file-export"></i> Export Timetable
                    </button>
                </div>
            </div>
            
            <div class="view-selector">
                <div class="view-option active" data-view="class">Class-wise</div>
                <div class="view-option" data-view="teacher">Teacher-wise</div>
                <div class="view-option" data-view="subject">Subject-wise</div>
            </div>
            
            <div class="filter-controls">
                <select id="classFilter" class="form-control">
                    <option value="">Select Class</option>
                    <option value="Grade-I-A">Grade I-A</option>
                    <option value="Grade-I-B">Grade I-B</option>
                    <option value="Grade-II-A">Grade II-A</option>
                    <option value="Grade-II-B">Grade II-B</option>
                </select>
                <select id="teacherFilter" class="form-control" style="display: none;">
                    <option value="">Select Teacher</option>
                    <option value="Indira">Indira</option>
                    <option value="Sai Priya">Sai Priya</option>
                    <option value="Uma Rani">Uma Rani</option>
                </select>
                <select id="subjectFilter" class="form-control" style="display: none;">
                    <option value="">Select Subject</option>
                    <option value="MATHS">Mathematics</option>
                    <option value="ENGLISH">English</option>
                    <option value="EVS">EVS</option>
                    <option value="Hindi">Hindi</option>
                </select>
                <button class="btn btn-primary" id="applyFilterBtn">
                    <i class="fas fa-filter"></i> Apply Filter
                </button>
            </div>
            
            <div class="timetable-container">
                <div id="timetableDisplay">
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No Timetable Loaded</h3>
                        <p>Upload a timetable using the "Upload Timetable" tab to view it here.</p>
                        <button class="btn btn-primary" id="goToUploadBtn">
                            <i class="fas fa-file-upload"></i> Go to Upload
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload Timetable Section -->
        <div class="content-section" id="upload-timetable-section">
            <div class="section-header">
                <h2><i class="fas fa-file-upload"></i> Upload Timetable</h2>
                <div class="section-actions">
                    <button class="btn btn-success" id="downloadTemplateBtn">
                        <i class="fas fa-file-download"></i> Download Template
                    </button>
                </div>
            </div>
            
            <div class="file-type-selector">
                <button class="file-type-btn active" data-type="excel">
                    <i class="fas fa-file-excel"></i> Excel Format
                </button>
                <button class="file-type-btn" data-type="csv">
                    <i class="fas fa-file-csv"></i> CSV Format
                </button>
            </div>
            
            <div class="upload-area" id="excelUploadArea">
                <i class="fas fa-file-excel"></i>
                <h3>Upload Excel Timetable File</h3>
                <p>Upload an Excel file in the required format. Make sure it follows the template structure.</p>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls">
                <label for="excelFileInput">Choose Excel File</label>
                <p id="selectedExcelFileName" style="margin-top: 15px; font-style: italic;"></p>
            </div>
            
            <div class="upload-area" id="csvUploadArea" style="display: none;">
                <i class="fas fa-file-csv"></i>
                <h3>Upload CSV Timetable File</h3>
                <p>Upload a CSV file with format: Class-Section,Day,P1,P2,... where each period has format: TeacherID:TeacherName:Subject</p>
                <input type="file" id="csvFileInput" accept=".csv, .txt">
                <label for="csvFileInput">Choose CSV File</label>
                <p id="selectedCSVFileName" style="margin-top: 15px; font-style: italic;"></p>
            </div>
            
            <div id="uploadStatus" style="display: none;">
                <div class="summary-card">
                    <h3>Upload Status</h3>
                    <div id="uploadDetails"></div>
                </div>
            </div>
            
            <div id="timetableDataInfo" style="display: none;">
                <div class="section-header">
                    <h3><i class="fas fa-info-circle"></i> Uploaded Timetable Data</h3>
                </div>
                <div class="data-summary">
                    <div class="summary-card">
                        <h3>Classes</h3>
                        <div class="value" id="classesCount">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Periods</h3>
                        <div class="value" id="periodsCount">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Teachers</h3>
                        <div class="value" id="teachersCount">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Subjects</h3>
                        <div class="value" id="subjectsCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modify Timetable Section -->
        <div class="content-section" id="modify-timetable-section">
            <div class="section-header">
                <h2><i class="fas fa-edit"></i> Modify Timetable</h2>
                <div class="section-actions">
                    <button class="btn btn-primary" id="rescheduleModeBtn">
                        <i class="fas fa-exchange-alt"></i> Reschedule Mode
                    </button>
                </div>
            </div>
            
            <div class="reschedule-controls" id="rescheduleControls" style="display: none;">
                <div>Reschedule Mode: Select two periods to swap</div>
                <button class="btn btn-success" id="confirmSwapBtn">
                    <i class="fas fa-check"></i> Confirm Swap
                </button>
                <button class="btn btn-danger" id="cancelSwapBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
            
            <div class="filter-controls">
                <select id="modifyClassFilter" class="form-control">
                    <option value="">Select Class</option>
                    <option value="Grade-I-A">Grade I-A</option>
                    <option value="Grade-I-B">Grade I-B</option>
                    <option value="Grade-II-A">Grade II-A</option>
                    <option value="Grade-II-B">Grade II-B</option>
                </select>
                <button class="btn btn-primary" id="loadTimetableBtn">
                    <i class="fas fa-sync-alt"></i> Load Timetable
                </button>
            </div>
            
            <div class="timetable-container">
                <div id="modifyTimetableDisplay">
                    <div class="empty-state">
                        <i class="fas fa-edit"></i>
                        <h3>No Timetable Loaded for Modification</h3>
                        <p>Select a class and load its timetable to make modifications.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Teacher Schedule Section -->
        <div class="content-section" id="teacher-schedule-section">
            <div class="section-header">
                <h2><i class="fas fa-chalkboard-teacher"></i> Teacher Schedule</h2>
                <div class="section-actions">
                    <button class="btn btn-success" id="exportTeacherScheduleBtn">
                        <i class="fas fa-file-export"></i> Export Schedule
                    </button>
                </div>
            </div>
            
            <div class="filter-controls">
                <select id="teacherScheduleFilter" class="form-control">
                    <option value="">Select Teacher</option>
                    <option value="Indira">Indira</option>
                    <option value="Sai Priya">Sai Priya</option>
                    <option value="Uma Rani">Uma Rani</option>
                </select>
                <button class="btn btn-primary" id="loadTeacherScheduleBtn">
                    <i class="fas fa-search"></i> Load Schedule
                </button>
            </div>
            
            <div class="timetable-container">
                <div id="teacherScheduleDisplay">
                    <div class="empty-state">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <h3>No Teacher Schedule Loaded</h3>
                        <p>Select a teacher to view their schedule.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>School Timetable Manager &copy; 2026 | For Admin Use Only</p>
        </footer>
    </div>
    
    <!-- Add Holiday Modal -->
    <div class="modal" id="addHolidayModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Holiday</h3>
                <button class="close-modal" id="closeHolidayModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="holidayName">Holiday Name</label>
                    <input type="text" id="holidayName" class="form-control" placeholder="E.g., Independence Day">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="holidayDate">Date</label>
                        <input type="date" id="holidayDate" class="form-control" value="2026-01-01">
                    </div>
                    <div class="form-group">
                        <label for="holidayType">Type</label>
                        <select id="holidayType" class="form-control">
                            <option value="public">Public Holiday</option>
                            <option value="school">School Holiday</option>
                            <option value="optional">Optional Holiday</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="holidayDescription">Description (Optional)</label>
                    <textarea id="holidayDescription" class="form-control" rows="3" placeholder="Add any additional details about this holiday"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelHolidayBtn">Cancel</button>
                <button class="btn btn-success" id="saveHolidayBtn">Save Holiday</button>
            </div>
        </div>
    </div>
    
    <!-- Time Input Modal for CSV -->
    <div class="modal" id="timeInputModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Set Period Times</h3>
                <button class="close-modal" id="closeTimeModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Please enter the time for each period. Empty periods will be shown as breaks.</p>
                <div id="timeInputContainer"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelTimeBtn">Cancel</button>
                <button class="btn btn-success" id="saveTimeBtn">Save Times</button>
            </div>
        </div>
    </div>
    
    <!-- Reschedule Modal -->
    <div class="modal" id="rescheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reschedule Periods</h3>
                <button class="close-modal" id="closeRescheduleModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="swapInfo">
                    <p>You are about to swap the following periods:</p>
                    <div id="period1Info" style="padding: 15px; background-color: #f0f4ff; border-radius: 5px; margin-bottom: 10px;"></div>
                    <div style="text-align: center; margin: 10px 0;">
                        <i class="fas fa-exchange-alt fa-2x" style="color: var(--primary-color);"></i>
                    </div>
                    <div id="period2Info" style="padding: 15px; background-color: #f0f4ff; border-radius: 5px; margin-bottom: 10px;"></div>
                    <p style="margin-top: 15px; font-weight: 600;">This action cannot be undone. Do you want to proceed?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="cancelRescheduleBtn">Cancel</button>
                <button class="btn btn-success" id="confirmRescheduleBtn">Confirm Swap</button>
            </div>
        </div>
    </div>
    
    <script>
        // Application state
        const state = {
            timetableData: null,
            holidays: [],
            currentView: 'class',
            selectedPeriods: [],
            rescheduleMode: false,
            currentYear: '2026',
            periodTimes: {},
            fileType: 'excel'
        };
        
        // Sample data for demonstration
        const sampleHolidays = [
            { id: 1, name: "New Year's Day", date: "2026-01-01", type: "public", description: "Celebration of the new year" },
            { id: 2, name: "Republic Day", date: "2026-01-26", type: "public", description: "Celebration of the adoption of the Constitution" },
            { id: 3, name: "Summer Break", date: "2026-05-15", type: "school", description: "Summer vacation for students" },
            { id: 4, name: "Independence Day", date: "2026-08-15", type: "public", description: "Celebration of India's independence" },
            { id: 5, name: "Diwali", date: "2026-10-29", type: "optional", description: "Festival of lights" },
            { id: 6, name: "Christmas", date: "2026-12-25", type: "public", description: "Celebration of Christmas" }
        ];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage if available
            loadFromLocalStorage();
            
            // Set up tab navigation
            setupTabs();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize the UI
            initUI();
        });
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            const storedTimetable = localStorage.getItem('schoolTimetable');
            const storedHolidays = localStorage.getItem('schoolHolidays');
            const storedPeriodTimes = localStorage.getItem('periodTimes');
            
            if (storedTimetable) {
                state.timetableData = JSON.parse(storedTimetable);
            }
            
            if (storedHolidays) {
                state.holidays = JSON.parse(storedHolidays);
            } else {
                // Use sample holidays if none stored
                state.holidays = sampleHolidays;
                saveHolidaysToStorage();
            }
            
            if (storedPeriodTimes) {
                state.periodTimes = JSON.parse(storedPeriodTimes);
            }
        }
        
        // Save timetable to localStorage
        function saveTimetableToStorage() {
            if (state.timetableData) {
                localStorage.setItem('schoolTimetable', JSON.stringify(state.timetableData));
            }
        }
        
        // Save holidays to localStorage
        function saveHolidaysToStorage() {
            localStorage.setItem('schoolHolidays', JSON.stringify(state.holidays));
        }
        
        // Save period times to localStorage
        function savePeriodTimesToStorage() {
            localStorage.setItem('periodTimes', JSON.stringify(state.periodTimes));
        }
        
        // Set up tab navigation
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    
                    // Remove active class from all tabs and sections
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab and corresponding section
                    this.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Dashboard button
            document.getElementById('dashboardBtn').addEventListener('click', function() {
                alert("Redirecting to Dashboard...");
            });
            
            // Holiday management
            document.getElementById('addHolidayBtn').addEventListener('click', openAddHolidayModal);
            document.getElementById('addFirstHolidayBtn').addEventListener('click', openAddHolidayModal);
            document.getElementById('exportHolidaysBtn').addEventListener('click', exportHolidays);
            document.getElementById('yearSelect').addEventListener('change', function() {
                state.currentYear = this.value;
                renderHolidays();
            });
            
            // Holiday modal
            document.getElementById('closeHolidayModal').addEventListener('click', closeAddHolidayModal);
            document.getElementById('cancelHolidayBtn').addEventListener('click', closeAddHolidayModal);
            document.getElementById('saveHolidayBtn').addEventListener('click', saveHoliday);
            
            // File type selector
            document.querySelectorAll('.file-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.file-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    state.fileType = this.getAttribute('data-type');
                    
                    // Show/hide appropriate upload areas
                    document.getElementById('excelUploadArea').style.display = state.fileType === 'excel' ? 'block' : 'none';
                    document.getElementById('csvUploadArea').style.display = state.fileType === 'csv' ? 'block' : 'none';
                });
            });
            
            // View timetable
            document.querySelectorAll('.view-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.view-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    state.currentView = this.getAttribute('data-view');
                    
                    // Show/hide appropriate filters
                    const classFilter = document.getElementById('classFilter');
                    const teacherFilter = document.getElementById('teacherFilter');
                    const subjectFilter = document.getElementById('subjectFilter');
                    
                    classFilter.style.display = state.currentView === 'class' ? 'block' : 'none';
                    teacherFilter.style.display = state.currentView === 'teacher' ? 'block' : 'none';
                    subjectFilter.style.display = state.currentView === 'subject' ? 'block' : 'none';
                    
                    renderTimetable();
                });
            });
            
            document.getElementById('applyFilterBtn').addEventListener('click', renderTimetable);
            document.getElementById('exportTimetableBtn').addEventListener('click', exportTimetable);
            document.getElementById('goToUploadBtn').addEventListener('click', function() {
                document.querySelector('.tab[data-target="upload-timetable-section"]').click();
            });
            
            // Upload timetable
            document.getElementById('excelFileInput').addEventListener('change', handleExcelUpload);
            document.getElementById('csvFileInput').addEventListener('change', handleCSVUpload);
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            
            // Time modal
            document.getElementById('closeTimeModal').addEventListener('click', closeTimeInputModal);
            document.getElementById('cancelTimeBtn').addEventListener('click', closeTimeInputModal);
            document.getElementById('saveTimeBtn').addEventListener('click', savePeriodTimes);
            
            // Modify timetable
            document.getElementById('rescheduleModeBtn').addEventListener('click', toggleRescheduleMode);
            document.getElementById('loadTimetableBtn').addEventListener('click', loadTimetableForModification);
            
            // Teacher schedule
            document.getElementById('loadTeacherScheduleBtn').addEventListener('click', loadTeacherSchedule);
            document.getElementById('exportTeacherScheduleBtn').addEventListener('click', exportTeacherSchedule);
            
            // Reschedule modal
            document.getElementById('closeRescheduleModal').addEventListener('click', closeRescheduleModal);
            document.getElementById('cancelRescheduleBtn').addEventListener('click', closeRescheduleModal);
            document.getElementById('confirmRescheduleBtn').addEventListener('click', confirmReschedule);
        }
        
        // Initialize the UI
        function initUI() {
            renderHolidays();
            
            // If timetable data exists, show it
            if (state.timetableData) {
                updateTimetableSummary();
                renderTimetable();
            }
        }
        
        // Render holidays list
        function renderHolidays() {
            const holidaysList = document.getElementById('holidaysList');
            const yearHolidays = state.holidays.filter(h => h.date.startsWith(state.currentYear));
            
            // Update summary counts
            document.getElementById('totalHolidays').textContent = yearHolidays.length;
            document.getElementById('publicHolidays').textContent = yearHolidays.filter(h => h.type === 'public').length;
            document.getElementById('schoolHolidays').textContent = yearHolidays.filter(h => h.type === 'school').length;
            document.getElementById('optionalHolidays').textContent = yearHolidays.filter(h => h.type === 'optional').length;
            
            if (yearHolidays.length === 0) {
                holidaysList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-umbrella-beach"></i>
                        <h3>No Holidays Added Yet</h3>
                        <p>Start by adding your first holiday. You can add public holidays, school holidays, or optional holidays.</p>
                        <button class="btn btn-primary" id="addFirstHolidayBtn">
                            <i class="fas fa-plus"></i> Add First Holiday
                        </button>
                    </div>
                `;
                document.getElementById('addFirstHolidayBtn').addEventListener('click', openAddHolidayModal);
                return;
            }
            
            let html = '<div class="holiday-cards">';
            
            yearHolidays.forEach(holiday => {
                const typeClass = `${holiday.type}-holiday`;
                const typeLabel = holiday.type === 'public' ? 'Public Holiday' : 
                                 holiday.type === 'school' ? 'School Holiday' : 'Optional Holiday';
                
                html += `
                    <div class="holiday-card ${typeClass}">
                        <div class="holiday-date">${formatDate(holiday.date)}</div>
                        <h3>${holiday.name}</h3>
                        <p><strong>Type:</strong> ${typeLabel}</p>
                        ${holiday.description ? `<p>${holiday.description}</p>` : ''}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger btn-sm" onclick="deleteHoliday(${holiday.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            holidaysList.innerHTML = html;
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
        }
        
        // Open add holiday modal
        function openAddHolidayModal() {
            document.getElementById('addHolidayModal').classList.add('active');
            document.getElementById('holidayDate').value = `${state.currentYear}-01-01`;
        }
        
        // Close add holiday modal
        function closeAddHolidayModal() {
            document.getElementById('addHolidayModal').classList.remove('active');
            // Clear form
            document.getElementById('holidayName').value = '';
            document.getElementById('holidayDescription').value = '';
        }
        
        // Save holiday
        function saveHoliday() {
            const name = document.getElementById('holidayName').value;
            const date = document.getElementById('holidayDate').value;
            const type = document.getElementById('holidayType').value;
            const description = document.getElementById('holidayDescription').value;
            
            if (!name || !date) {
                alert("Please fill in all required fields.");
                return;
            }
            
            const newHoliday = {
                id: state.holidays.length > 0 ? Math.max(...state.holidays.map(h => h.id)) + 1 : 1,
                name,
                date,
                type,
                description
            };
            
            state.holidays.push(newHoliday);
            saveHolidaysToStorage();
            renderHolidays();
            closeAddHolidayModal();
        }
        
        // Delete holiday
        function deleteHoliday(id) {
            if (confirm("Are you sure you want to delete this holiday?")) {
                state.holidays = state.holidays.filter(h => h.id !== id);
                saveHolidaysToStorage();
                renderHolidays();
            }
        }
        
        // Export holidays
        function exportHolidays() {
            // In a real app, this would generate an Excel or PDF file
            alert("Exporting holidays to Excel file...");
            
            // For demo, we'll create a simple CSV
            const yearHolidays = state.holidays.filter(h => h.date.startsWith(state.currentYear));
            let csv = "Name,Date,Type,Description\n";
            
            yearHolidays.forEach(holiday => {
                csv += `"${holiday.name}","${holiday.date}","${holiday.type}","${holiday.description || ''}"\n`;
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `holidays_${state.currentYear}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Handle Excel file upload
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedExcelFileName').textContent = `Selected file: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Process the workbook
                    processExcelWorkbook(workbook);
                } catch (error) {
                    console.error("Error reading Excel file:", error);
                    alert("Error reading Excel file. Please make sure it's in the correct format.");
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // Handle CSV file upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('selectedCSVFileName').textContent = `Selected file: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    // Process the CSV
                    processCSVData(csvData, file.name);
                } catch (error) {
                    console.error("Error reading CSV file:", error);
                    alert("Error reading CSV file. Please make sure it's in the correct format.");
                }
            };
            
            reader.readAsText(file);
        }
        
        // Process uploaded Excel workbook
        function processExcelWorkbook(workbook) {
            // Clear previous data
            state.timetableData = {};
            
            // Process each sheet
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Process the data based on the template format
                processExcelSheetData(sheetName, jsonData);
            });
            
            // Save to localStorage
            saveTimetableToStorage();
            
            // Update UI
            updateTimetableSummary();
            renderTimetable();
            
            // Show upload status
            document.getElementById('uploadStatus').style.display = 'block';
            document.getElementById('uploadDetails').innerHTML = `
                <p><i class="fas fa-check-circle" style="color: var(--success-color);"></i> Timetable uploaded successfully!</p>
                <p>Processed ${workbook.SheetNames.length} classes.</p>
            `;
            
            document.getElementById('timetableDataInfo').style.display = 'block';
        }
        
        // Process Excel sheet data
        function processExcelSheetData(sheetName, data) {
            // Skip header rows
            if (data.length < 3) return;
            
            const classData = {
                className: sheetName,
                days: []
            };
            
            // Process each row starting from row 2 (0-indexed)
            for (let i = 2; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                const day = {
                    dayName: row[0],
                    periods: []
                };
                
                // Process each period (8 periods in the template)
                for (let p = 0; p < 8; p++) {
                    const baseIndex = p * 5;
                    const period = {
                        period: p + 1,
                        subject: row[baseIndex + 1] || '',
                        teacherName: row[baseIndex + 2] || '',
                        teacherId: row[baseIndex + 3] || '',
                        time: row[baseIndex + 4] || getPeriodTime(p + 1),
                        type: row[baseIndex + 5] || 'Regular'
                    };
                    
                    day.periods.push(period);
                }
                
                classData.days.push(day);
            }
            
            // Store in state
            state.timetableData[sheetName] = classData;
        }
        
        // Process CSV data
        function processCSVData(csvData, fileName) {
            // Clear previous data
            state.timetableData = {};
            
            // Parse CSV
            const lines = csvData.split('\n');
            if (lines.length < 2) {
                alert("CSV file is empty or has invalid format.");
                return;
            }
            
            // Get headers
            const headers = lines[0].split(',');
            
            // Check if it's the new format
            if (headers[0] !== 'Class-Section' || headers[1] !== 'Day') {
                alert("CSV format not recognized. Expected format: Class-Section,Day,P1,P2,...");
                return;
            }
            
            // Get period columns (P1, P2, etc.)
            const periodColumns = headers.filter(h => h.startsWith('P'));
            const numPeriods = periodColumns.length;
            
            // Store period count for time input
            state.tempPeriodCount = numPeriods;
            state.tempCSVData = [];
            
            // Process each data line
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cells = parseCSVLine(line);
                if (cells.length < 2) continue;
                
                const classSection = cells[0];
                const day = cells[1];
                
                // Create class data structure if not exists
                if (!state.tempCSVData[classSection]) {
                    state.tempCSVData[classSection] = {
                        className: classSection,
                        days: []
                    };
                }
                
                // Find or create day entry
                let dayEntry = state.tempCSVData[classSection].days.find(d => d.dayName === day);
                if (!dayEntry) {
                    dayEntry = {
                        dayName: day,
                        periods: []
                    };
                    state.tempCSVData[classSection].days.push(dayEntry);
                }
                
                // Process each period
                for (let p = 0; p < numPeriods; p++) {
                    const periodData = cells[2 + p] || '';
                    
                    let teacherId = '';
                    let teacherName = '';
                    let subject = '';
                    
                    if (periodData && periodData.includes(':')) {
                        const parts = periodData.split(':');
                        teacherId = parts[0] || '';
                        teacherName = parts[1] || '';
                        subject = parts[2] || '';
                    } else if (periodData) {
                        // Handle case where there's data but not in expected format
                        subject = periodData;
                    }
                    
                    const period = {
                        period: p + 1,
                        subject: subject,
                        teacherName: teacherName,
                        teacherId: teacherId,
                        time: '', // Will be set later
                        type: 'Regular'
                    };
                    
                    dayEntry.periods.push(period);
                }
            }
            
            // Convert to array and show time input modal
            state.tempCSVData = Object.values(state.tempCSVData);
            openTimeInputModal(numPeriods);
        }
        
        // Parse CSV line considering quoted values
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }
        
        // Open time input modal
        function openTimeInputModal(numPeriods) {
            const container = document.getElementById('timeInputContainer');
            container.innerHTML = '';
            
            let html = '<div class="time-input-grid">';
            
            for (let i = 1; i <= numPeriods; i++) {
                const periodKey = `P${i}`;
                const currentTime = state.periodTimes[periodKey] || getDefaultPeriodTime(i);
                
                html += `
                    <div class="time-input-item">
                        <label for="time-P${i}">Period ${i} (P${i}) Time</label>
                        <input type="text" id="time-P${i}" value="${currentTime}" placeholder="e.g., 8:00-8:45">
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            document.getElementById('timeInputModal').classList.add('active');
        }
        
        // Close time input modal
        function closeTimeInputModal() {
            document.getElementById('timeInputModal').classList.remove('active');
            state.tempCSVData = null;
            state.tempPeriodCount = 0;
        }
        
        // Save period times
        function savePeriodTimes() {
            const numPeriods = state.tempPeriodCount;
            
            // Get all time inputs
            for (let i = 1; i <= numPeriods; i++) {
                const periodKey = `P${i}`;
                const timeInput = document.getElementById(`time-${periodKey}`);
                if (timeInput) {
                    state.periodTimes[periodKey] = timeInput.value.trim();
                }
            }
            
            // Save period times
            savePeriodTimesToStorage();
            
            // Now process the CSV data with times
            if (state.tempCSVData) {
                // Convert temp data to final format
                state.timetableData = {};
                
                state.tempCSVData.forEach(classData => {
                    const className = classData.className;
                    state.timetableData[className] = {
                        className: className,
                        days: []
                    };
                    
                    classData.days.forEach(day => {
                        const dayEntry = {
                            dayName: day.dayName,
                            periods: []
                        };
                        
                        day.periods.forEach(period => {
                            const periodKey = `P${period.period}`;
                            const periodTime = state.periodTimes[periodKey] || getDefaultPeriodTime(period.period);
                            
                            dayEntry.periods.push({
                                period: period.period,
                                subject: period.subject,
                                teacherName: period.teacherName,
                                teacherId: period.teacherId,
                                time: periodTime,
                                type: 'Regular'
                            });
                        });
                        
                        state.timetableData[className].days.push(dayEntry);
                    });
                });
                
                // Save to localStorage
                saveTimetableToStorage();
                
                // Update UI
                updateTimetableSummary();
                renderTimetable();
                
                // Show upload status
                document.getElementById('uploadStatus').style.display = 'block';
                document.getElementById('uploadDetails').innerHTML = `
                    <p><i class="fas fa-check-circle" style="color: var(--success-color);"></i> CSV Timetable uploaded successfully!</p>
                    <p>Processed ${state.tempCSVData.length} classes.</p>
                `;
                
                document.getElementById('timetableDataInfo').style.display = 'block';
            }
            
            // Update class filters
            updateClassFilters();
            
            // Close modal
            closeTimeInputModal();
        }
        
        // Get default period time
        function getDefaultPeriodTime(periodNumber) {
            // Default times starting from 8:00 AM, 45-minute periods
            const startHour = 8;
            const periodDuration = 45;
            const breakDuration = 15;
            
            let totalMinutes = (startHour * 60) + ((periodNumber - 1) * (periodDuration + breakDuration));
            
            // Adjust for breaks (assume break after 4th period)
            if (periodNumber > 4) {
                totalMinutes += 30; // Long break
            }
            
            const startHours = Math.floor(totalMinutes / 60);
            const startMinutes = totalMinutes % 60;
            const endHours = Math.floor((totalMinutes + periodDuration) / 60);
            const endMinutes = (totalMinutes + periodDuration) % 60;
            
            return `${startHours.toString().padStart(2, '0')}:${startMinutes.toString().padStart(2, '0')}-${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
        }
        
        // Get period time from stored times or default
        function getPeriodTime(periodNumber) {
            const periodKey = `P${periodNumber}`;
            if (state.periodTimes && state.periodTimes[periodKey]) {
                return state.periodTimes[periodKey];
            }
            return getDefaultPeriodTime(periodNumber);
        }
        
        // Update timetable summary
        function updateTimetableSummary() {
            if (!state.timetableData) return;
            
            const classes = Object.keys(state.timetableData);
            let periodsCount = 0;
            const teachers = new Set();
            const subjects = new Set();
            
            classes.forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.subject && period.subject !== '') {
                            periodsCount++;
                            if (period.teacherName) teachers.add(period.teacherName);
                            if (period.subject) subjects.add(period.subject);
                        }
                    });
                });
            });
            
            document.getElementById('classesCount').textContent = classes.length;
            document.getElementById('periodsCount').textContent = periodsCount;
            document.getElementById('teachersCount').textContent = teachers.size;
            document.getElementById('subjectsCount').textContent = subjects.size;
            
            // Update class filters
            updateClassFilters();
        }
        
        // Update class filters
        function updateClassFilters() {
            if (!state.timetableData) return;
            
            const classes = Object.keys(state.timetableData);
            
            // Update class filter in View Timetable
            const classFilter = document.getElementById('classFilter');
            classFilter.innerHTML = '<option value="">Select Class</option>';
            classes.forEach(className => {
                classFilter.innerHTML += `<option value="${className}">${className}</option>`;
            });
            
            // Update class filter in Modify Timetable
            const modifyClassFilter = document.getElementById('modifyClassFilter');
            modifyClassFilter.innerHTML = '<option value="">Select Class</option>';
            classes.forEach(className => {
                modifyClassFilter.innerHTML += `<option value="${className}">${className}</option>`;
            });
            
            // Update teacher filter
            const teachers = new Set();
            classes.forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.teacherName) teachers.add(period.teacherName);
                    });
                });
            });
            
            const teacherFilter = document.getElementById('teacherFilter');
            teacherFilter.innerHTML = '<option value="">Select Teacher</option>';
            teachers.forEach(teacher => {
                teacherFilter.innerHTML += `<option value="${teacher}">${teacher}</option>`;
            });
            
            const teacherScheduleFilter = document.getElementById('teacherScheduleFilter');
            teacherScheduleFilter.innerHTML = '<option value="">Select Teacher</option>';
            teachers.forEach(teacher => {
                teacherScheduleFilter.innerHTML += `<option value="${teacher}">${teacher}</option>`;
            });
            
            // Update subject filter
            const subjects = new Set();
            classes.forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.subject) subjects.add(period.subject);
                    });
                });
            });
            
            const subjectFilter = document.getElementById('subjectFilter');
            subjectFilter.innerHTML = '<option value="">Select Subject</option>';
            subjects.forEach(subject => {
                subjectFilter.innerHTML += `<option value="${subject}">${subject}</option>`;
            });
        }
        
        // Render timetable
        function renderTimetable() {
            const timetableDisplay = document.getElementById('timetableDisplay');
            
            if (!state.timetableData) {
                timetableDisplay.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No Timetable Loaded</h3>
                        <p>Upload a timetable using the "Upload Timetable" tab to view it here.</p>
                        <button class="btn btn-primary" id="goToUploadBtn">
                            <i class="fas fa-file-upload"></i> Go to Upload
                        </button>
                    </div>
                `;
                document.getElementById('goToUploadBtn').addEventListener('click', function() {
                    document.querySelector('.tab[data-target="upload-timetable-section"]').click();
                });
                return;
            }
            
            // Get filter values
            const classFilter = document.getElementById('classFilter').value;
            const teacherFilter = document.getElementById('teacherFilter').value;
            const subjectFilter = document.getElementById('subjectFilter').value;
            
            let html = '';
            
            if (state.currentView === 'class') {
                // Show class-wise timetable
                const classesToShow = classFilter ? [classFilter] : Object.keys(state.timetableData);
                
                classesToShow.forEach(className => {
                    const classData = state.timetableData[className];
                    
                    html += `<h3 style="margin: 20px 0 10px 15px;">${className}</h3>`;
                    html += generateTimetableHTML(classData);
                });
            } else if (state.currentView === 'teacher') {
                // Show teacher-wise timetable
                html = generateTeacherTimetableHTML(teacherFilter);
            } else if (state.currentView === 'subject') {
                // Show subject-wise timetable
                html = generateSubjectTimetableHTML(subjectFilter);
            }
            
            timetableDisplay.innerHTML = html;
            
            // Check for overlaps if timetable is shown
            checkForOverlaps();
        }
        
        // Generate timetable HTML
        function generateTimetableHTML(classData) {
            if (!classData || !classData.days || classData.days.length === 0) {
                return '<p>No timetable data for this class.</p>';
            }
            
            // Determine number of periods from the first day
            const numPeriods = classData.days[0].periods.length;
            
            let html = '<table class="timetable">';
            
            // Header row
            html += '<thead><tr><th>Day/Period</th>';
            for (let i = 1; i <= numPeriods; i++) {
                html += `<th>P${i}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // Data rows - sort days in correct order
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            dayOrder.forEach(dayName => {
                const dayData = classData.days.find(d => d.dayName === dayName);
                
                if (!dayData) return;
                
                html += `<tr><td style="font-weight: 600; background-color: #f9f9f9;">${dayName}</td>`;
                
                dayData.periods.forEach(period => {
                    // Check if this is a holiday
                    const isHoliday = isDateHoliday(dayName);
                    
                    if (!period.subject || period.subject === '') {
                        html += `<td class="break-cell">BREAK</td>`;
                    } else if (isHoliday) {
                        html += `<td class="holiday-cell">HOLIDAY</td>`;
                    } else {
                        const overlapClass = period.overlap ? 'overlap' : '';
                        html += `
                            <td class="period-cell ${overlapClass}" data-class="${classData.className}" data-day="${dayName}" data-period="${period.period}">
                                ${period.overlap ? '<div class="overlap-warning"><i class="fas fa-exclamation-triangle"></i></div>' : ''}
                                <div class="period-subject">${period.subject}</div>
                                <div class="period-teacher">${period.teacherName}</div>
                                <div class="period-time">${period.time}</div>
                            </td>
                        `;
                    }
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Generate teacher timetable HTML
        function generateTeacherTimetableHTML(teacherFilter) {
            if (!teacherFilter) {
                return '<div class="empty-state"><p>Please select a teacher to view their schedule.</p></div>';
            }
            
            if (!state.timetableData) return '<p>No timetable data.</p>';
            
            // Find all classes where this teacher teaches
            const teacherClasses = {};
            const classNames = Object.keys(state.timetableData);
            
            classNames.forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.teacherName === teacherFilter && period.subject) {
                            if (!teacherClasses[className]) teacherClasses[className] = {};
                            if (!teacherClasses[className][day.dayName]) teacherClasses[className][day.dayName] = [];
                            teacherClasses[className][day.dayName].push(period);
                        }
                    });
                });
            });
            
            if (Object.keys(teacherClasses).length === 0) {
                return `<div class="empty-state"><p>No schedule found for teacher: ${teacherFilter}</p></div>`;
            }
            
            let html = `<h3 style="margin: 20px 0 10px 15px;">Schedule for ${teacherFilter}</h3>`;
            html += '<table class="timetable">';
            html += '<thead><tr><th>Day/Period</th>';
            
            // Get all classes this teacher teaches in
            const classes = Object.keys(teacherClasses);
            
            classes.forEach(className => {
                html += `<th>${className}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // Data rows
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            dayOrder.forEach(dayName => {
                html += `<tr><td style="font-weight: 600; background-color: #f9f9f9;">${dayName}</td>`;
                
                classes.forEach(className => {
                    const dayPeriods = teacherClasses[className][dayName] || [];
                    let periodInfo = '';
                    
                    if (dayPeriods.length > 0) {
                        // Show all periods for this teacher in this class on this day
                        const periodText = dayPeriods.map(p => 
                            `P${p.period}: ${p.subject}`
                        ).join('<br>');
                        
                        periodInfo = `
                            <div class="period-subject">${periodText}</div>
                        `;
                    }
                    
                    html += `<td class="period-cell">${periodInfo}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Generate subject timetable HTML
        function generateSubjectTimetableHTML(subjectFilter) {
            if (!subjectFilter) {
                return '<div class="empty-state"><p>Please select a subject to view its schedule.</p></div>';
            }
            
            if (!state.timetableData) return '<p>No timetable data.</p>';
            
            // Find all classes where this subject is taught
            const subjectClasses = {};
            const classNames = Object.keys(state.timetableData);
            
            classNames.forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.subject === subjectFilter) {
                            if (!subjectClasses[className]) subjectClasses[className] = {};
                            if (!subjectClasses[className][day.dayName]) subjectClasses[className][day.dayName] = [];
                            subjectClasses[className][day.dayName].push(period);
                        }
                    });
                });
            });
            
            if (Object.keys(subjectClasses).length === 0) {
                return `<div class="empty-state"><p>No schedule found for subject: ${subjectFilter}</p></div>`;
            }
            
            let html = `<h3 style="margin: 20px 0 10px 15px;">Schedule for ${subjectFilter}</h3>`;
            html += '<table class="timetable">';
            html += '<thead><tr><th>Day/Period</th>';
            
            // Get all classes where this subject is taught
            const classes = Object.keys(subjectClasses);
            
            classes.forEach(className => {
                html += `<th>${className}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            // Data rows
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            dayOrder.forEach(dayName => {
                html += `<tr><td style="font-weight: 600; background-color: #f9f9f9;">${dayName}</td>`;
                
                classes.forEach(className => {
                    const dayPeriods = subjectClasses[className][dayName] || [];
                    let periodInfo = '';
                    
                    if (dayPeriods.length > 0) {
                        // Show all periods for this subject in this class on this day
                        const periodText = dayPeriods.map(p => 
                            `P${p.period}: ${p.teacherName}`
                        ).join('<br>');
                        
                        periodInfo = `
                            <div class="period-subject">${periodText}</div>
                        `;
                    }
                    
                    html += `<td class="period-cell">${periodInfo}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }
        
        // Check if a date is a holiday
        function isDateHoliday(dayName) {
            // In a real app, this would check against actual dates
            // For demo, we'll just check for weekends
            return dayName === 'Saturday' || dayName === 'Sunday';
        }
        
        // Check for overlaps in the timetable
        function checkForOverlaps() {
            if (!state.timetableData) return;
            
            // Reset all overlaps
            Object.keys(state.timetableData).forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        period.overlap = false;
                    });
                });
            });
            
            // Check for teacher overlaps
            const teacherSchedule = {};
            
            Object.keys(state.timetableData).forEach(className => {
                const classData = state.timetableData[className];
                classData.days.forEach(day => {
                    day.periods.forEach(period => {
                        if (period.teacherName && period.teacherName !== '' && period.subject) {
                            const key = `${day.dayName}-${period.time}-${period.teacherName}`;
                            
                            if (teacherSchedule[key]) {
                                // Found an overlap
                                teacherSchedule[key].push({ className, day: day.dayName, period: period.period });
                                period.overlap = true;
                            } else {
                                teacherSchedule[key] = [{ className, day: day.dayName, period: period.period }];
                            }
                        }
                    });
                });
            });
            
            // Mark all periods in overlaps
            Object.values(teacherSchedule).forEach(periods => {
                if (periods.length > 1) {
                    periods.forEach(p => {
                        const classData = state.timetableData[p.className];
                        const dayData = classData.days.find(d => d.dayName === p.day);
                        if (dayData) {
                            const periodData = dayData.periods.find(per => per.period === p.period);
                            if (periodData) {
                                periodData.overlap = true;
                            }
                        }
                    });
                }
            });
            
            // Re-render if needed
            if (document.getElementById('view-timetable-section').classList.contains('active')) {
                renderTimetable();
            }
        }
        
        // Export timetable
        function exportTimetable() {
            if (!state.timetableData) {
                alert("No timetable data to export.");
                return;
            }
            
            // Ask for export format
            const format = prompt("Export as Excel or CSV? (Enter 'excel' or 'csv')", "excel");
            
            if (!format || (format !== 'excel' && format !== 'csv')) {
                alert("Invalid format selected.");
                return;
            }
            
            if (format === 'excel') {
                exportToExcel();
            } else {
                exportToCSV();
            }
        }
        
        // Export to Excel
        function exportToExcel() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Add each class as a sheet
            Object.keys(state.timetableData).forEach(className => {
                const classData = state.timetableData[className];
                
                // Create header row
                const header = ['Day'];
                const numPeriods = classData.days[0].periods.length;
                
                for (let i = 1; i <= numPeriods; i++) {
                    header.push(`P${i} Subject`, `P${i} Teacher Name`, `P${i} Teacher ID`, `P${i} Time`, `P${i} Type`);
                }
                
                const data = [header];
                
                // Add each day's data
                const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                dayOrder.forEach(dayName => {
                    const dayData = classData.days.find(d => d.dayName === dayName);
                    if (!dayData) return;
                    
                    const row = [dayName];
                    
                    dayData.periods.forEach(period => {
                        row.push(period.subject || '');
                        row.push(period.teacherName || '');
                        row.push(period.teacherId || '');
                        row.push(period.time || '');
                        row.push(period.type || 'Regular');
                    });
                    
                    data.push(row);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, className);
            });
            
            // Generate and download file
            XLSX.writeFile(wb, 'school_timetable_export.xlsx');
        }
        
        // Export to CSV (new format)
        function exportToCSV() {
            let csv = 'Class-Section,Day';
            
            // Get number of periods from first class
            const firstClass = Object.keys(state.timetableData)[0];
            if (!firstClass) return;
            
            const numPeriods = state.timetableData[firstClass].days[0].periods.length;
            
            // Add period headers
            for (let i = 1; i <= numPeriods; i++) {
                csv += `,P${i}`;
            }
            csv += '\n';
            
            // Add data for each class
            Object.keys(state.timetableData).forEach(className => {
                const classData = state.timetableData[className];
                
                const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                dayOrder.forEach(dayName => {
                    const dayData = classData.days.find(d => d.dayName === dayName);
                    if (!dayData) return;
                    
                    csv += `${className},${dayName}`;
                    
                    dayData.periods.forEach(period => {
                        if (period.subject && period.teacherName) {
                            csv += `,${period.teacherId || ''}:${period.teacherName}:${period.subject}`;
                        } else {
                            csv += ',';
                        }
                    });
                    
                    csv += '\n';
                });
            });
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'school_timetable.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Download template
        function downloadTemplate() {
            if (state.fileType === 'excel') {
                downloadExcelTemplate();
            } else {
                downloadCSVTemplate();
            }
        }
        
        // Download Excel template
        function downloadExcelTemplate() {
            // Create a simple template with sample data
            const wb = XLSX.utils.book_new();
            
            // Sample classes
            const classes = ['Class1A', 'Class1B', 'Class2A', 'Class2B'];
            
            classes.forEach(className => {
                // Create header row
                const header = [
                    'Day', 'P1 Subject', 'P1 Teacher Name', 'P1 Teacher ID', 'P1 Time', 'P1 Type',
                    'P2 Subject', 'P2 Teacher Name', 'P2 Teacher ID', 'P2 Time', 'P2 Type',
                    'P3 Subject', 'P3 Teacher Name', 'P3 Teacher ID', 'P3 Time', 'P3 Type',
                    'P4 Subject', 'P4 Teacher Name', 'P4 Teacher ID', 'P4 Time', 'P4 Type',
                    'P5 Subject', 'P5 Teacher Name', 'P5 Teacher ID', 'P5 Time', 'P5 Type',
                    'P6 Subject', 'P6 Teacher Name', 'P6 Teacher ID', 'P6 Time', 'P6 Type',
                    'P7 Subject', 'P7 Teacher Name', 'P7 Teacher ID', 'P7 Time', 'P7 Type',
                    'P8 Subject', 'P8 Teacher Name', 'P8 Teacher ID', 'P8 Time', 'P8 Type'
                ];
                
                const data = [header];
                
                // Add days
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                
                days.forEach(day => {
                    const row = [day];
                    
                    // Add sample periods
                    for (let i = 1; i <= 8; i++) {
                        if (i === 4) {
                            // Break period
                            row.push('BREAK', '', '', '11:00-11:30', 'Regular');
                        } else {
                            row.push('Mathematics', 'John Doe', '17PVSS0001', `${8+i}:00-${8+i}:45`, 'Regular');
                        }
                    }
                    
                    data.push(row);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, className);
            });
            
            // Generate and download file
            XLSX.writeFile(wb, 'timetable_template.xlsx');
        }
        
        // Download CSV template
        function downloadCSVTemplate() {
            // Create CSV template with sample data
            let csv = 'Class-Section,Day,P1,P2,P3,P4,P5,P6,P7,P8,P9,P10\n';
            csv += 'Grade-I-A,Monday,T001:Indira:MATHS,T001:Indira:ENGLISH,T002:Sai Priya:EVS,T003:Uma Rani:Hindi,T004:Pravalika:Maths,,,,,\n';
            csv += 'Grade-I-A,Tuesday,T001:Indira:ENGLISH,T001:Indira:ENGLISH,T002:Sai Priya:EVS,T003:Uma Rani:Hindi,T004:Pravalika:Maths,,,,,\n';
            csv += 'Grade-I-A,Wednesday,T001:Indira:Telugu,T001:Indira:ENGLISH,T007:Suresh:Games,T003:Uma Rani:Hindi,T008:Adiba:EVS,,,,,\n';
            
            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'timetable_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Toggle reschedule mode
        function toggleRescheduleMode() {
            state.rescheduleMode = !state.rescheduleMode;
            state.selectedPeriods = [];
            
            const rescheduleControls = document.getElementById('rescheduleControls');
            const rescheduleBtn = document.getElementById('rescheduleModeBtn');
            
            if (state.rescheduleMode) {
                rescheduleControls.style.display = 'flex';
                rescheduleBtn.innerHTML = '<i class="fas fa-times"></i> Exit Reschedule Mode';
                rescheduleBtn.classList.add('btn-danger');
                rescheduleBtn.classList.remove('btn-primary');
                
                // Add click listeners to timetable cells
                addRescheduleListeners();
            } else {
                rescheduleControls.style.display = 'none';
                rescheduleBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Reschedule Mode';
                rescheduleBtn.classList.remove('btn-danger');
                rescheduleBtn.classList.add('btn-primary');
                
                // Remove highlight from selected cells
                document.querySelectorAll('.swap-highlight').forEach(cell => {
                    cell.classList.remove('swap-highlight');
                });
                
                // Remove click listeners
                removeRescheduleListeners();
            }
        }
        
        // Add reschedule listeners
        function addRescheduleListeners() {
            const cells = document.querySelectorAll('.period-cell');
            cells.forEach(cell => {
                cell.addEventListener('click', handlePeriodSelection);
            });
        }
        
        // Remove reschedule listeners
        function removeRescheduleListeners() {
            const cells = document.querySelectorAll('.period-cell');
            cells.forEach(cell => {
                cell.removeEventListener('click', handlePeriodSelection);
            });
        }
        
        // Handle period selection for rescheduling
        function handlePeriodSelection(event) {
            const cell = event.currentTarget;
            const className = cell.getAttribute('data-class');
            const dayName = cell.getAttribute('data-day');
            const periodNum = parseInt(cell.getAttribute('data-period'));
            
            // Check if already selected
            const isSelected = state.selectedPeriods.some(p => 
                p.className === className && p.dayName === dayName && p.period === periodNum
            );
            
            if (isSelected) {
                // Deselect
                cell.classList.remove('swap-highlight');
                state.selectedPeriods = state.selectedPeriods.filter(p => 
                    !(p.className === className && p.dayName === dayName && p.period === periodNum)
                );
            } else {
                // Select (max 2 periods)
                if (state.selectedPeriods.length < 2) {
                    cell.classList.add('swap-highlight');
                    state.selectedPeriods.push({
                        className,
                        dayName,
                        period: periodNum
                    });
                    
                    // If 2 periods selected, enable swap button
                    if (state.selectedPeriods.length === 2) {
                        document.getElementById('confirmSwapBtn').disabled = false;
                    }
                }
            }
        }
        
        // Load timetable for modification
        function loadTimetableForModification() {
            const classFilter = document.getElementById('modifyClassFilter').value;
            
            if (!classFilter) {
                alert("Please select a class to load.");
                return;
            }
            
            if (!state.timetableData || !state.timetableData[classFilter]) {
                alert("No timetable data found for this class.");
                return;
            }
            
            const modifyTimetableDisplay = document.getElementById('modifyTimetableDisplay');
            const classData = state.timetableData[classFilter];
            
            modifyTimetableDisplay.innerHTML = `
                <h3 style="margin: 20px 0 10px 15px;">${classData.className}</h3>
                ${generateTimetableHTML(classData)}
            `;
            
            // Add click listeners if in reschedule mode
            if (state.rescheduleMode) {
                addRescheduleListeners();
            }
        }
        
        // Load teacher schedule
        function loadTeacherSchedule() {
            const teacherFilter = document.getElementById('teacherScheduleFilter').value;
            
            if (!teacherFilter) {
                alert("Please select a teacher to load schedule.");
                return;
            }
            
            const teacherScheduleDisplay = document.getElementById('teacherScheduleDisplay');
            teacherScheduleDisplay.innerHTML = generateTeacherTimetableHTML(teacherFilter);
        }
        
        // Export teacher schedule
        function exportTeacherSchedule() {
            const teacherFilter = document.getElementById('teacherScheduleFilter').value;
            
            if (!teacherFilter) {
                alert("Please select a teacher to export schedule.");
                return;
            }
            
            alert(`Exporting schedule for ${teacherFilter}...`);
            // In a real app, this would generate an Excel or PDF file
        }
        
        // Open reschedule modal
        function openRescheduleModal() {
            if (state.selectedPeriods.length !== 2) {
                alert("Please select exactly two periods to swap.");
                return;
            }
            
            // Get period details
            const period1 = getPeriodDetails(state.selectedPeriods[0]);
            const period2 = getPeriodDetails(state.selectedPeriods[1]);
            
            document.getElementById('period1Info').innerHTML = `
                <strong>${period1.className} - ${period1.dayName} - Period ${period1.period}</strong><br>
                Subject: ${period1.subject}<br>
                Teacher: ${period1.teacherName}<br>
                Time: ${period1.time}
            `;
            
            document.getElementById('period2Info').innerHTML = `
                <strong>${period2.className} - ${period2.dayName} - Period ${period2.period}</strong><br>
                Subject: ${period2.subject}<br>
                Teacher: ${period2.teacherName}<br>
                Time: ${period2.time}
            `;
            
            document.getElementById('rescheduleModal').classList.add('active');
        }
        
        // Close reschedule modal
        function closeRescheduleModal() {
            document.getElementById('rescheduleModal').classList.remove('active');
        }
        
        // Confirm reschedule
        function confirmReschedule() {
            if (state.selectedPeriods.length !== 2) {
                alert("Please select exactly two periods to swap.");
                return;
            }
            
            const period1 = state.selectedPeriods[0];
            const period2 = state.selectedPeriods[1];
            
            // Swap the periods
            swapPeriods(period1, period2);
            
            // Save to storage
            saveTimetableToStorage();
            
            // Update UI
            loadTimetableForModification();
            closeRescheduleModal();
            
            // Reset selection
            state.selectedPeriods = [];
            document.querySelectorAll('.swap-highlight').forEach(cell => {
                cell.classList.remove('swap-highlight');
            });
            
            alert("Periods swapped successfully!");
        }
        
        // Get period details
        function getPeriodDetails(periodInfo) {
            const classData = state.timetableData[periodInfo.className];
            const dayData = classData.days.find(d => d.dayName === periodInfo.dayName);
            const periodData = dayData.periods.find(p => p.period === periodInfo.period);
            
            return {
                className: periodInfo.className,
                dayName: periodInfo.dayName,
                period: periodInfo.period,
                subject: periodData.subject,
                teacherName: periodData.teacherName,
                time: periodData.time
            };
        }
        
        // Swap periods
        function swapPeriods(period1, period2) {
            const classData1 = state.timetableData[period1.className];
            const dayData1 = classData1.days.find(d => d.dayName === period1.dayName);
            const periodData1 = dayData1.periods.find(p => p.period === period1.period);
            
            const classData2 = state.timetableData[period2.className];
            const dayData2 = classData2.days.find(d => d.dayName === period2.dayName);
            const periodData2 = dayData2.periods.find(p => p.period === period2.period);
            
            // Swap the subject, teacher, and ID (keep time and type)
            const tempSubject = periodData1.subject;
            const tempTeacherName = periodData1.teacherName;
            const tempTeacherId = periodData1.teacherId;
            
            periodData1.subject = periodData2.subject;
            periodData1.teacherName = periodData2.teacherName;
            periodData1.teacherId = periodData2.teacherId;
            
            periodData2.subject = tempSubject;
            periodData2.teacherName = tempTeacherName;
            periodData2.teacherId = tempTeacherId;
        }
        
        // Set up reschedule controls
        document.getElementById('confirmSwapBtn').addEventListener('click', openRescheduleModal);
        document.getElementById('cancelSwapBtn').addEventListener('click', function() {
            toggleRescheduleMode();
        });
    </script>
</body>
</html>
